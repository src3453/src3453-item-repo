<!DOCTYPE html>
<html lang="ja">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebSerial API Console</title>
    <script>
        let port;

        async function onConnectButtonClick() {
            try {
                port = await navigator.serial.requestPort();
                baud = Number(document.getElementById("baudrate"));

                await port.open({ baudRate: baud,dataBit: db, stopBit: sb,parity:  par});

                while (port.readable) {
                    const reader = port.readable.getReader();

                    try {
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) {
                                addSerial("Canceled\n");
                                break;
                            }
                            const inputValue = new TextDecoder().decode(value);
                            addSerial(inputValue);
                        }
                    } catch (error) {
                        addSerial("Error: Read" + error + "\n");
                    } finally {
                        reader.releaseLock();
                    }
                }
            } catch (error) {
                addSerial("Error: Open" + error + "\n");
            }
        }

        function addSerial(msg) {
            var textarea = document.getElementById('outputArea');
            textarea.value += msg;
            textarea.scrollTop = textarea.scrollHeight;
        }

        async function sendSerial() {
            var text = document.getElementById('sendInput').value;
            document.getElementById('sendInput').value = "";
            //document.getElementById("outputarea").textContent =
            const encoder = new TextEncoder();
            const writer = port.writable.getWriter();
            await writer.write(encoder.encode(text + "\n"));
            writer.releaseLock();
        }
    </script>
</head>

<body>
    <div class="container-fluid">
        <h1>WebSerial API Console</h1>
        <button class="btn btn-primary" onclick="onConnectButtonClick()">Connect</button> baud<select name="baudrate"><option>110</option>
            <option>300</option>
            <option>600</option>
            <option>1200</option>
            <option>2400</option>
            <option>4800</option>
            <option>9600</option>
            <option>14400</option>
            <option>19200</option>
            <option>38400</option>
            <option>57600</option>
            <option selected>115200</option>
            <option>128000</option>
            <option>256000</option>
        </select> dataBit <select name="db"><option>7</option><option selected>8</option></select> stopBit <select name="sb"><option selected>1</option><option>2</option></select> parity <select name="par"><option>none</option selected><option>even</option><option>odd</option></select>
            
        <br />

        <input type="text" id="sendInput" class="w-50"/>
        <input type="button" value="Send" class="btn btn-success" onclick="sendSerial();" />
        <br />
        <textarea cols="80" rows="12" id="outputArea" readonly style="font-family:'Courier New', Courier, monospace;color: darkgreen;background-color: white;"></textarea>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    </div>
</body>

</html>